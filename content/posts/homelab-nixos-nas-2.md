+++
title = "My NixOS NAS🧊 (2)"
date = 2025-10-17
+++

# My NixOS NAS🧊 (2)

2025-10-17

You can find [my configuration here](https://github.com/antipeth/atplab).
You can find [my previous article here](https://blog.0pt.icu/posts/homelab-nixos-nas/).

---

## 🪄 Introduction

Back in **March**, I built my NAS using **NixOS**, and it’s been running **rock-solid** ever since 💪.
However, this August I made some big hardware and backup changes. For some reason, I bought an extra **32 GB RAM stick**, bringing my NAS’s total memory to **40 GB** 🧠.

I also purchased a **Western Digital HC620 zoned mechanical drive (SMR)** — **14 TB** — to store my static media files 🎬.
I couldn’t format this drive using `nixos disko`, but `mkfs` worked perfectly, and mounting it with `filesystem` caused no conflicts at all.

| Name        | Content                |
| ----------- | ---------------------- |
| Motherboard | GIGABYTE A520i Dash    |
| CPU         | R5 5600G               |
| Memory      | 8 GB + 32 GB DDR4      |
| SSD         | 512 GB NVMe PCIe 3 × 4 |
| HDD         | 2 × 1 TB               |
| HDD         | 14 TB                  |

Because my **dorm cuts power every night** 🔌, I can’t keep the mechanical drives constantly connected — it would wear them out too fast.
So I turned them into **cold backups**, doing a scheduled sync **once per month** 🧊.
Of course, my local data is still **backed up to S3 daily** ☁️.

I also bought a **VPS** to host my online services 🌐.

So, it was time to **rebuild my NixOS NAS** — transforming it into a proper **NixOS-based homelab environment** 🧰.

---

## 🏗️ Rebuild

### 🔁 Replacing `clan` with `nixos-rebuild`

In my previous article, I highly recommended the `clan` tool.
Unfortunately… I’ve decided to drop it 😅.

1. Since March, `clan` has had major updates — mostly around the `inventory` system. But I don’t really need that; I want my setup to stay **as close to pure NixOS** as possible.
2. One big reason I originally used `clan` was for **multi-host deployment** and management. But after an update, I found that when deploying just one machine, `clan` still **checks the configuration of all machines** — which conflicts with my **SOPS-encrypted values and secrets** approach 🔐.
3. Also, even though I configure my network through `networking` and *not* `systemd-network`, `clan` still automatically enables it 🤔. This isn’t a big issue locally or on some VPSs, but on certain ones it **completely breaks IPv6** 💥.

`clan` is a great project — just not the right fit for me anymore.
So I switched back to the good old **`nixos-rebuild`** 🧱.

For multi-machine deployment, I now use a **Justfile** with scripts that dynamically insert the hostname using `seq`, and I simply **avoid committing these transient changes** to Git 🧹.

---

### 🔒 Using `nixos-sops`

Previously, I used the SOPS integration built into `clan`.
Now I use **SOPS directly**, with a cleaner directory structure for encryption 🔧.

Let’s look at what changed 👇

**Before (with `clan`):**

* Secrets were stored in `sops/secrets/`.
* Encrypted values or strings were stored in `sops/eval/<machine-name>/`.

**After the rebuild:**

* Secrets are now stored in `machines/<machine-name>/secrets/`.
* Encrypted values or strings are now stored in `machines/<machine-name>/values/`.

You can find my related article about SOPS encryption here. 👇
- [Sops-nix Quick Start Guide](https://blog.0pt.icu/posts/nixos-sops-nix-quick-start-guide/)
- [Using SOPS to Encrypt Nix Values](https://blog.0pt.icu/posts/nixos-using-sops-to-encrypt-nix-values/)

This makes import paths in Nix much simpler ✨.

---

### 🔐 Switching from ACME Certificates to Self-Signed Certificates

At first, my NixOS NAS used **ACME** certificates, integrated nicely with Nginx.
But once I added a VPS, I needed a way to **distribute certificates** among machines 📨.

Here was my initial idea 💭:

1. The VPS runs a **Headscale** server, and both cloud and local machines join the Headscale network 🕸️.
2. The VPS obtains certificates via **ACME**.
3. The VPS uses **rclone** to encrypt and store the certs in another local directory.
4. Nginx on the VPS serves an **HTTPS static file server** (inside the Headscale network, using the domain generated by `magic_dns`) 🌐.
5. Other machines use **rclone’s HTTP backend** to periodically pull and decrypt the certs locally 🔁.

But when I actually started setting it up… I got lazy 😆.
So I just went with **self-signed certificates** — zero maintenance required.

For local services, that’s perfectly fine ✅.
For cloud services, combining **self-signed certs + CDN** is totally enough for a personal **homelab** setup 🏠.

---

### 🧩 Other Improvements

* ☁️ Added Headscale in the cloud to manage all devices within a private network.
* 🗂️ Reorganized the **directory structure**.
* 🌀 Used a **recursive import function** (`lib.filesystem.listFilesRecursive`) to simplify Nix code.
* 📁 All example service modules are now stored under `machines/example/modules/`.
