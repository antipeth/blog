<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=你在世纪大道东门 name=description><link href=/main.css rel=stylesheet><script src=/js/theme-toggle.js></script><script>document.documentElement.classList.toggle('dark-mode', 
            localStorage.getItem('theme') === 'dark' || 
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)
        );</script><title>世纪大道</title><link href=/favicon.ico rel=icon type=image/x-icon><script defer src=/js/posts/copy2clipboard.js></script><body><header><nav><a href=https://blog.0pt.icu/atom.xml>/rss</a><a href=https://blog.0pt.icu>/home</a><a href=https://blog.0pt.icu/posts>/posts</a><a href=https://blog.0pt.icu/links>/links</a><a href=https://blog.0pt.icu/about>/about</a></nav><div class=theme-toggle-container><input aria-label=theme-toggle class=checkbox id=checkbox type=checkbox><label class=checkbox-label for=checkbox><span class=ball></span></label></div></header><div><h1>x79搭建pve并开启硬件直通</h1><span>2024-09-17</span><div class=toc><ul><li><a href=https://blog.0pt.icu/posts/pve-build-pve/#x79da-jian-pvebing-kai-qi-ying-jian-zhi-tong>x79搭建pve并开启硬件直通</a> <ul><li><a href=https://blog.0pt.icu/posts/pve-build-pve/#ying-jian-pei-zhi>硬件配置</a><li><a href=https://blog.0pt.icu/posts/pve-build-pve/#zhu-ban-jie-shao>主板介绍</a><li><a href=https://blog.0pt.icu/posts/pve-build-pve/#zhu-yi-shi-xiang>注意事项</a><li><a href=https://blog.0pt.icu/posts/pve-build-pve/#biosshe-zhi>BIOS设置</a><li><a href=https://blog.0pt.icu/posts/pve-build-pve/#an-zhuang-pve>安装pve</a><li><a href=https://blog.0pt.icu/posts/pve-build-pve/#pvezhu-yi-shi-xiang>pve注意事项</a><li><a href=https://blog.0pt.icu/posts/pve-build-pve/#kai-qi-zhi-tong>开启直通</a><li><a href=https://blog.0pt.icu/posts/pve-build-pve/#pei-zhi-sheng-dian>配置省电</a></ul></ul></div><h1 id=x79da-jian-pvebing-kai-qi-ying-jian-zhi-tong>x79搭建pve并开启硬件直通</h1><p>2024-09-17<p>从去年就买了一个服务器主板和相关配件学习装机，一直都没用起来。开学后想着利用起来，开个pve玩玩。<h2 id=ying-jian-pei-zhi>硬件配置</h2><table><thead><tr><th>Item<th>name<th>price<tbody><tr><td>主板<td>x79浪潮m2220(2011针)<td>152￥<tr><td>cpu<td>至强e5-2651v2 x 2<td>26x2=52￥<tr><td>内存<td>1866Mhz镁光16G ddr3服务器内存条 x 2<td>27x2=54￥<tr><td>散热器<td>杂牌塔式散热 x 2<td>29x2=58￥<tr><td>显卡<td>盈通游戏高手R9 270<td>120￥<tr><td>硬盘<td>梵想ssd固态128G<td>79￥<tr><td>电源<td>华为服务器电源750w+电源转接板+模组线<td>41+71+65=177￥<tr><td>机箱<td>开放式机箱<td>39￥<tr><td>总计<td><td>731￥</table><h2 id=zhu-ban-jie-shao>主板介绍</h2><table><thead><tr><th>Item<th>name<tbody><tr><td>主板尺寸<td>E-ATX 30.5cm x 33.2cm<tr><td>内存<td>4通道 20个ddr3<tr><td>sata<td>2个sata3 8个sata2<tr><td>pcie<td>3个pci-e 16x 3个pci-e 8x<tr><td>usb<td>3个usb2<tr><td>vga<td>板载显卡，有1个vga口<tr><td>网口<td>2个千兆网口(intel i350芯片) 1个远程口(IPMI)</table><h2 id=zhu-yi-shi-xiang>注意事项</h2><h3 id=xian-qia>显卡</h3><p>显卡别看pci-e 16x 有3个，能支持的显卡长度必须小于18.5cm，不然会顶到内存插槽，且如果显卡宽度大于1.5cm,则会把旁边的那个pcie口一起占用。 板载显卡在某些情况（非正常情况）下可能会有冲突。<h3 id=san-re-qi>散热器</h3><p>注意买标准的长方形2011针，不是正方形。<h2 id=biosshe-zhi>BIOS设置</h2><p>按<code>Del</code>进bios<h3 id=cpu>cpu</h3><p>vt-d开启，虚拟化开启 cpu的几个增强设置全部打开<h3 id=ying-pan>硬盘</h3><p><code>Advanced</code>-><code>SATA Configuration</code>-><code>SATA Mode</code> ,把<code>IDE Mode</code>改为<code>AHCI Mode</code><h3 id=shi-pin-shu-chu-xin-hao-zou-ban-zai-xian-qia-gai-wei-zou-du-xian>视频输出信号走板载显卡改为走独显</h3><p><code>Chipset</code>-><code>CPU Advanced Settings</code>-><code>IOH Configuration</code>-><code>VGA Priority</code>,把<code>Onboard</code>改为<code>Offboard</code><h2 id=an-zhuang-pve>安装pve</h2><p>没什么好说的，直接安装即可<h2 id=pvezhu-yi-shi-xiang>pve注意事项</h2><h3 id=shi-yong-wu-xian-wang-qia-lian-wang>使用无线网卡联网</h3><p>无线网卡连接手机热点，并使用nat配置给虚拟机联网，我使用这种方法有问题，虚拟机内无网络(我看别人的相关文章，无线网卡连接的是路由器wifi，成功配置网络。)<h3 id=shi-yong-usblian-wang>使用usb联网</h3><p>usb网路共享也有问题，每次需要手动配置网络接口。使用以下脚本 通过手机 rndis 自动联网配置 效果是：手机线连接 pve 开启 USB 网络共享后，5秒左右自动配置好 rndis 网络<p>代码部分：<p>/etc/systemd/system/rndis.service<pre style=color:#c0c5ce;background-color:#2b303b><code><span>[Unit]
</span><span>Description=Run RNDIS script every 5 seconds
</span><span>After=network.target
</span><span>
</span><span>[Service]
</span><span>ExecStart=bash /root/rndis.sh
</span><span>Restart=always
</span><span>RestartSec=5
</span><span>
</span><span>[Install]
</span><span>WantedBy=multi-user.target
</span></code></pre><p>/root/rndis.sh<pre style=color:#c0c5ce;background-color:#2b303b><code><span>#!/bin/bash
</span><span>
</span><span>ANDROID_USB_IP="192.168.42.100"
</span><span>ANDROID_USB_GATEWAY="192.168.42.1"
</span><span>ANDROID_USB_SUBNET="255.255.255.0"
</span><span>PVE_DEFAULT_GATEWAY="192.168.100.1"
</span><span>
</span><span># 获取 enx 开头的网卡设备名称
</span><span>enx_interface=$(ip a | grep "enx[0-9a-f:]*:" | awk '{print $2}' | head -n 1 | sed 's/:$//')
</span><span>
</span><span># 检查是否获取到网卡名称
</span><span>if [ -z "$enx_interface" ]; then
</span><span>  echo "Error: Could not find enx interface."
</span><span>  exit 1
</span><span>fi
</span><span>
</span><span># 打印输出网卡名称
</span><span>echo "Detected enx interface: $enx_interface"
</span><span>
</span><span># 备份 /etc/network/interfaces
</span><span>if [ -f /etc/network/interfaces.bak ]; then
</span><span>  rm /etc/network/interfaces.bak
</span><span>  echo "Delete original backup."
</span><span>fi
</span><span>cp /etc/network/interfaces /etc/network/interfaces.bak
</span><span>echo "Backup /etc/network/interfaces"
</span><span>
</span><span># 检查 /etc/network/interfaces 是否包含 enx[mac] 字段
</span><span>if grep -q "enx[0-9a-f]*" /etc/network/interfaces; then
</span><span>  # 检查是否与新获取的网卡名称相同
</span><span>  if grep -q "$enx_interface" /etc/network/interfaces; then
</span><span>    echo "Network interface name already matches, no changes made."
</span><span>  else
</span><span>    # 替换 /etc/network/interfaces 中的网卡名称
</span><span>    sed -i "s/enx[0-9a-f]*/$enx_interface/g" /etc/network/interfaces
</span><span>    echo "Network interface name updated in /etc/network/interfaces."
</span><span>  fi
</span><span>else
</span><span>  # 追加新的网卡配置
</span><span>  cat >> /etc/network/interfaces <&LTEOF
</span><span>
</span><span>auto $enx_interface
</span><span>iface $enx_interface inet static
</span><span>        address $ANDROID_USB_IP
</span><span>        netmask $ANDROID_USB_SUBNET
</span><span>        gateway $ANDROID_USB_GATEWAY
</span><span>EOF
</span><span>  echo "New network interface configuration appended to /etc/network/interfaces."
</span><span>fi
</span><span>
</span><span># 删除旧路由并添加新路由
</span><span>ip route delete default via $PVE_DEFAULT_GATEWAY
</span><span>ip route add default via $ANDROID_USB_GATEWAY
</span><span>
</span><span>echo "Network configuration updated successfully."
</span><span>
</span><span># 检查网络连接
</span><span>if ! ping -c 1 1.1.1.1 > /dev/null 2>&1; then
</span><span>    echo "Network is down, restarting networking service..."
</span><span>    # 仅当网络不可用时重启网络服务
</span><span>    systemctl restart networking.service
</span><span>else
</span><span>    echo "Network is up."
</span><span>fi
</span><span>    echo "Done."
</span></code></pre><h2 id=kai-qi-zhi-tong>开启直通</h2><p>参考<a href=https://pve.sqlsec.com/4/2/>国光的教程</a> 以下是自己配的<h3 id=kai-qi-iommu>开启IOMMU</h3><pre style=color:#c0c5ce;background-color:#2b303b><code><span>nano /etc/default/grub
</span></code></pre><p>将<pre style=color:#c0c5ce;background-color:#2b303b><code><span>GRUB_CMDLINE_LINUX_DEFAULT="quiet"
</span></code></pre><p>改为(包含直通优化，关闭显卡以节能的相关参数)<pre style=color:#c0c5ce;background-color:#2b303b><code><span>GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on iommu=pt textonly nomodeset nofb pci=noaer pcie_acs_override=downstream,multifunction video=vesafb:off video=efifb:off video=simplefb:off initcall_blacklist=sysfb_init"
</span></code></pre><p>然后使用<pre style=color:#c0c5ce;background-color:#2b303b><code><span>update-grub
</span></code></pre><p>验证IOMMU是否开启<pre style=color:#c0c5ce;background-color:#2b303b><code><span>dmesg | grep -e DMAR -e IOMMU
</span></code></pre><p>出现<code>DMAR: IOMMU enabled</code>则说明开启成功，还不行重启后再看一下。<h3 id=tian-jia-vfio-mo-kuai>添加 VFIO 模块</h3><p>为了我们的显卡顺利直通，需要添加 VFIO 模块到 /etc/modules 文件中：<pre class=language-Bash data-lang=Bash style=color:#c0c5ce;background-color:#2b303b><code class=language-Bash data-lang=Bash><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>vfio</span><span>" > /etc/modules
</span><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>vfio_iommu_type1s</span><span>" >> /etc/modules
</span><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>vfio_pci</span><span>" >> /etc/modules
</span><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>vfio_virqfd</span><span>" >> /etc/modules
</span></code></pre><p>将常见的驱动程序加入黑名单，即让 GPU 相关设备在下次系统启动之后不使用这些驱动，把设备腾出来给 vfio 驱动用：<pre class=language-Bash data-lang=Bash style=color:#c0c5ce;background-color:#2b303b><code class=language-Bash data-lang=Bash><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>blacklist nvidiafb</span><span>" >> /etc/modprobe.d/blacklist.conf
</span><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>blacklist nouveau</span><span>" >> /etc/modprobe.d/blacklist.conf
</span><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>blacklist nvidia</span><span>" >> /etc/modprobe.d/blacklist.conf
</span><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>blacklist radeon</span><span>" >> /etc/modprobe.d/blacklist.conf
</span><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>blacklist amdgpu</span><span>" >> /etc/modprobe.d/blacklist.conf
</span><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>blacklist snd_hda_intel</span><span>" >> /etc/modprobe.d/blacklist.conf
</span><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>blacklist snd_hda_codec_hdmi</span><span>" >> /etc/modprobe.d/blacklist.conf
</span><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>blacklist i915</span><span>" >> /etc/modprobe.d/blacklist.conf
</span></code></pre><p>然后更新内核重启机器：<pre class=language-Bash data-lang=Bash style=color:#c0c5ce;background-color:#2b303b><code class=language-Bash data-lang=Bash><span style=color:#bf616a>update-initramfs -u </span><span>&& </span><span style=color:#bf616a>reboot
</span></code></pre><h3 id=yan-zheng-iommu-zhong-duan-zhong-xin-ying-she-shi-fou-yi-qi-yong>验证 IOMMU 中断重新映射是否已启用</h3><pre style=color:#c0c5ce;background-color:#2b303b><code><span>dmesg | grep 'remapping'
</span></code></pre><p>看到以下行之一：<pre style=color:#c0c5ce;background-color:#2b303b><code><span>AMD-Vi: Interrupt remapping enabled
</span><span>DMAR-IR: Enabled IRQ remapping in x2apic mode
</span></code></pre><h3 id=bu-zhi-dao-zhe-shi-sha>不知道这是啥</h3><pre style=color:#c0c5ce;background-color:#2b303b><code><span>nano /etc/modprobe.d/pve-blacklist.conf
</span></code></pre><p>添加<pre style=color:#c0c5ce;background-color:#2b303b><code><span>options vfio_iommu_type1 allow_unsafe_interrupts=1
</span></code></pre><h3 id=sheng-cheng-xian-qia-romfile>生成显卡romfile</h3><p>在window下，使用gpu-z提取。 把<code>.rom文件</code>（我的是R9-270.rom）放到pve的<code>/usr/share/kvm/</code>目录下面 在虚拟机配置下添加pcie设备，选择显卡，勾选主<code>gpu</code>和<code>rombar</code> 编辑虚拟机配置<pre style=color:#c0c5ce;background-color:#2b303b><code><span>nano /etc/pve/qemu-server/100.conf
</span></code></pre><p>修改<pre style=color:#c0c5ce;background-color:#2b303b><code><span># hostpci0: 01:00
</span><span>hostpci0: 01:00,x-vga=1,romfile=R9-270.rom
</span></code></pre><h3 id=pei-zhi-ying-pan-zhi-tong>配置硬盘直通</h3><p>参考<a href=https://foxi.buduanwang.vip/virtualization/1754.html/>佛西博客</a> 我们可以通过下面命令，列出当前的硬盘列表<pre style=color:#c0c5ce;background-color:#2b303b><code><span>ls -la /dev/disk/by-id/|grep -v dm|grep -v lvm|grep -v part
</span></code></pre><p>如下面的例子<pre style=color:#c0c5ce;background-color:#2b303b><code><span>root@pve:~# ls -la /dev/disk/by-id/|grep -v dm|grep -v lvm|grep -v part
</span><span>total 0
</span><span>drwxr-xr-x 2 root root 540 Apr 28 16:39 .
</span><span>drwxr-xr-x 6 root root 120 Mar  3 15:52 ..
</span><span>lrwxrwxrwx 1 root root  13 Apr 28 16:39 nvme-eui.01000000010000005cd2e431fee65251 -> ../../nvme2n1
</span><span>lrwxrwxrwx 1 root root  13 Mar  3 15:52 nvme-eui.334843304aa010020025385800000004 -> ../../nvme1n1
</span><span>lrwxrwxrwx 1 root root  13 Apr 28 17:36 nvme-eui.334843304ab005400025385800000004 -> ../../nvme0n1
</span><span>lrwxrwxrwx 1 root root  13 Apr 28 16:39 nvme-INTEL_SSDPE2KX020T8_BTLJ039307142P0BGN -> ../../nvme2n1
</span><span>lrwxrwxrwx 1 root root  13 Mar  3 15:52 nvme-SAMSUNG_MZWLL800HEHP-00003_S3HCNX0JA01002 -> ../../nvme1n1
</span><span>lrwxrwxrwx 1 root root  13 Apr 28 17:36 nvme-SAMSUNG_MZWLL800HEHP-00003_S3HCNX0JB00540 -> ../../nvme0n1
</span><span>lrwxrwxrwx 1 root root   9 Mar  3 15:52 scsi-35000c500474cd7eb -> ../../sda
</span><span>lrwxrwxrwx 1 root root   9 Mar  3 15:52 wwn-0x5000c500474cd7eb -> ../../sda
</span></code></pre><p>nvme开头的是nvme硬盘，ata开头是走sata或者ata通道的设备。，scsi是scsi设备-阵列卡raid或者是直通卡上的硬盘。 我们可以通过<code>qm set &LTvmid> --scsiX /dev/disk/by-id/xxxxxxx</code> 进行RDM直通<pre style=color:#c0c5ce;background-color:#2b303b><code><span>#   虚拟机编号 控制器类型编号 物理磁盘挂载点
</span><span>qm set 101 --scsi1 /dev/disk/by-id/nvme-INTEL_SSDPE2KX020T8_BTLJ039307142P0BGN
</span></code></pre><h3 id=jiang-jing-xiang-xie-cheng-ci-pan-ge-shi>将镜像写成磁盘格式</h3><pre style=color:#c0c5ce;background-color:#2b303b><code><span>#                    虚拟机编号           存放镜像的位置                                      储存池
</span><span>qm disk import 100 /var/lib/vz/template/iso/openwrt.img local-lvm
</span></code></pre><p>参考连接 https://pve.proxmox.com/wiki/PCI_Passthrough#Verify_IOMMU_is_enabled https://www.bilibili.com/opus/848481909029732376?spm_id_from=333.976.0.0 https://www.bilibili.com/read/cv34418465/ https://pve.sqlsec.com/7/4/#_2<h2 id=pei-zhi-sheng-dian>配置省电</h2><p>安装<code>cpupower</code><pre style=color:#c0c5ce;background-color:#2b303b><code><span>apt install cpupower
</span><span>
</span><span># 设置所有CPU为节能模式
</span><span>cpupower -c all frequency-set -g powersave
</span><span>
</span><span># 设置所有CPU为性能模式
</span><span>cpupower -c all frequency-set -g performance
</span><span>编辑 root 用户的 crontab:
</span></code></pre><p>命令重启后设置的会失效，下面持久化这个命令，让其开机自动执行<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>sudo</span><span> crontab</span><span style=color:#bf616a> -e
</span></code></pre><p>添加以下内容以在启动时运行命令:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>@reboot /usr/bin/cpupower -c all frequency-set -g powersave
</span></code></pre></div>